var pe=Object.defineProperty;var ge=(v,A,N)=>A in v?pe(v,A,{enumerable:!0,configurable:!0,writable:!0,value:N}):v[A]=N;var c=(v,A,N)=>(ge(v,typeof A!="symbol"?A+"":A,N),N);(function(){"use strict";function W(e){return e.next()|0}function m(e,t){return t===0?e:n=>e(n)+t}function $(e){const t=e.next()|0,n=e.next()>>>0;return(t&2097151)*4294967296+n+(t&2097152?-9007199254740992:0)}function ht(e){for(;;){const t=e.next()|0;if(t&4194304){if((t&8388607)===4194304&&(e.next()|0)===0)return 9007199254740992}else{const n=e.next()>>>0;return(t&2097151)*4294967296+n+(t&2097152?-9007199254740992:0)}}}function ot(e){return e.next()>>>0}function G(e){const t=e.next()&2097151,n=e.next()>>>0;return t*4294967296+n}function X(e){for(;;){const t=e.next()|0;if(t&2097152){if((t&2097151)===0&&(e.next()|0)===0)return 9007199254740992}else{const n=e.next()>>>0;return(t&2097151)*4294967296+n}}}function at(e){return(e+1&e)===0}function Mt(e){return t=>t.next()&e}function Ut(e){const t=e+1,n=t*Math.floor(4294967296/t);return i=>{let r=0;do r=i.next()>>>0;while(r>=n);return r%t}}function Lt(e){return at(e)?Mt(e):Ut(e)}function Rt(e){return(e|0)===0}function kt(e){return t=>{const n=t.next()&e,i=t.next()>>>0;return n*4294967296+i}}function Ft(e){const t=e*Math.floor(9007199254740992/e);return n=>{let i=0;do{const r=n.next()&2097151,s=n.next()>>>0;i=r*4294967296+s}while(i>=t);return i%e}}function Zt(e){const t=e+1;if(Rt(t)){const n=(t/4294967296|0)-1;if(at(n))return kt(n)}return Ft(t)}function ct(e,t){return n=>{let i=0;do{const r=n.next()|0,s=n.next()>>>0;i=(r&2097151)*4294967296+s+(r&2097152?-9007199254740992:0)}while(i<e||i>t);return i}}function b(e,t){if(e=Math.floor(e),t=Math.floor(t),e<-9007199254740992||!isFinite(e))throw new RangeError(`Expected min to be at least ${-9007199254740992}`);if(t>9007199254740992||!isFinite(t))throw new RangeError(`Expected max to be at most ${9007199254740992}`);const n=t-e;return n<=0||!isFinite(n)?()=>e:n===4294967295?e===0?ot:m(W,e+2147483648):n<4294967295?m(Lt(n),e):n===9007199254740991?m(G,e):n<9007199254740991?m(Zt(n),e):t-1-e===9007199254740991?m(X,e):e===-9007199254740992&&t===9007199254740992?ht:e===-9007199254740992&&t===9007199254740991?$:e===-9007199254740991&&t===9007199254740992?m($,1):t===9007199254740992?m(ct(e-1,t-1),1):ct(e,t)}function Gt(e){return(e.next()&1)===1}function z(e,t){return n=>e(n)<t}function Bt(e){if(e<=0)return()=>!1;if(e>=1)return()=>!0;{const t=e*4294967296;return t%1===0?z(W,t-2147483648|0):z(G,Math.round(e*9007199254740992))}}function Dt(e,t){return t==null?e==null?Gt:Bt(e):e<=0?()=>!1:e>=t?()=>!0:z(b(0,t-1),e)}function Ot(e,t){const n=b(+e,+t);return i=>new Date(n(i))}function _t(e){return b(1,e)}function Ct(e,t){const n=_t(e);return i=>{const r=[];for(let s=0;s<t;++s)r.push(n(i));return r}}const Wt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-";function P(e=Wt){const t=e.length;if(!t)throw new Error("Expected pool not to be an empty string");const n=b(0,t-1);return(i,r)=>{let s="";for(let h=0;h<r;++h){const o=n(i);s+=e.charAt(o)}return s}}const lt="0123456789abcdef",$t=P(lt),Xt=P(lt.toUpperCase());function zt(e){return e?Xt:$t}function ut(e,t){return e<0?Math.max(e+t,0):Math.min(e,t)}function dt(e){const t=+e;return t<0?Math.ceil(t):Math.floor(t)}function Pt(e,t,n,i){const r=t.length;if(r===0)throw new RangeError("Cannot pick from an empty array");const s=n==null?0:ut(dt(n),r),h=i===void 0?r:ut(dt(i),r);if(s>=h)throw new RangeError(`Cannot pick between bounds ${s} and ${h}`);const o=b(s,h-1);return t[o(e)]}function jt(e,t){return t===1?e:t===0?()=>0:n=>e(n)*t}function ft(e){return G(e)/9007199254740992}function pt(e){return X(e)/9007199254740992}function Ht(e,t,n=!1){if(isFinite(e)){if(!isFinite(t))throw new RangeError("Expected max to be a finite number")}else throw new RangeError("Expected min to be a finite number");return m(jt(n?pt:ft,t-e),e)}const Vt=Array.prototype.slice;function j(e,t,n=0){const i=t.length;if(i)for(let r=i-1>>>0;r>n;--r){const h=b(0,r)(e);if(r!==h){const o=t[r];t[r]=t[h],t[h]=o}}return t}function Yt(e,t,n){if(n<0||n>t.length||!isFinite(n))throw new RangeError("Expected sampleSize to be within 0 and the length of the population");if(n===0)return[];const i=Vt.call(t),r=i.length;if(r===n)return j(e,i,0);const s=r-n;return j(e,i,s-1).slice(s)}const Kt=(()=>{try{if("x".repeat(3)==="xxx")return(e,t)=>e.repeat(t)}catch{}return(e,t)=>{let n="";for(;t>0;)t&1&&(n+=e),t>>=1,e+=e;return n}})();function M(e,t){return Kt("0",t-e.length)+e}function Jt(e){const t=e.next()>>>0,n=e.next()|0,i=e.next()|0,r=e.next()>>>0;return M(t.toString(16),8)+"-"+M((n&65535).toString(16),4)+"-"+M((n>>4&4095|16384).toString(16),4)+"-"+M((i&16383|32768).toString(16),4)+"-"+M((i>>4&65535).toString(16),4)+M(r.toString(16),8)}const gt={next(){return Math.random()*4294967296|0}};class Et{constructor(t=gt){this.engine=t}int32(){return W(this.engine)}uint32(){return ot(this.engine)}uint53(){return G(this.engine)}uint53Full(){return X(this.engine)}int53(){return $(this.engine)}int53Full(){return ht(this.engine)}integer(t,n){return b(t,n)(this.engine)}realZeroToOneInclusive(){return pt(this.engine)}realZeroToOneExclusive(){return ft(this.engine)}real(t,n,i=!1){return Ht(t,n,i)(this.engine)}bool(t,n){return Dt(t,n)(this.engine)}pick(t,n,i){return Pt(this.engine,t,n,i)}shuffle(t){return j(this.engine,t)}sample(t,n){return Yt(this.engine,t,n)}die(t){return _t(t)(this.engine)}dice(t,n){return Ct(t,n)(this.engine)}uuid4(){return Jt(this.engine)}string(t,n){return P(n)(this.engine,t)}hex(t,n){return zt(n)(this.engine,t)}date(t,n){return Ot(t,n)(this.engine)}}const Qt=(()=>{try{const e=new ArrayBuffer(4),t=new Int32Array(e);if(t[0]=2147483648,t[0]===-2147483648)return Int32Array}catch{}return Array})();function qt(e=gt,t=16){const n=[];n.push(new Date().getTime()|0);for(let i=1;i<t;++i)n[i]=e.next()|0;return n}const H=(()=>{try{if(Math.imul(4294967295,5)===-5)return Math.imul}catch{}const e=65535;return(t,n)=>{const i=t>>>16&e,r=t&e,s=n>>>16&e,h=n&e;return r*h+(i*h+r*s<<16>>>0)|0}})(),y=624,I=y-1,V=397,yt=y-V,Y=2567483615;class U{constructor(){this.data=new Qt(y),this.index=0,this.uses=0}static seed(t){return new U().seed(t)}static seedWithArray(t){return new U().seedWithArray(t)}static autoSeed(){return U.seedWithArray(qt())}next(){(this.index|0)>=y&&(K(this.data),this.index=0);const t=this.data[this.index];return this.index=this.index+1|0,this.uses+=1,te(t)|0}getUseCount(){return this.uses}discard(t){if(t<=0)return this;for(this.uses+=t,(this.index|0)>=y&&(K(this.data),this.index=0);t+this.index>y;)t-=y-this.index,K(this.data),this.index=0;return this.index=this.index+t|0,this}seed(t){let n=0;this.data[0]=n=t|0;for(let i=1;i<y;i=i+1|0)this.data[i]=n=H(n^n>>>30,1812433253)+i|0;return this.index=y,this.uses=0,this}seedWithArray(t){return this.seed(19650218),ee(this.data,t),this}}function K(e){let t=0,n=0;for(;(t|0)<yt;t=t+1|0)n=e[t]&2147483648|e[t+1|0]&2147483647,e[t]=e[t+V|0]^n>>>1^(n&1?Y:0);for(;(t|0)<I;t=t+1|0)n=e[t]&2147483648|e[t+1|0]&2147483647,e[t]=e[t-yt|0]^n>>>1^(n&1?Y:0);n=e[I]&2147483648|e[0]&2147483647,e[I]=e[V-1]^n>>>1^(n&1?Y:0)}function te(e){return e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,e^e>>>18}function ee(e,t){let n=1,i=0;const r=t.length;let s=Math.max(r,y)|0,h=e[0]|0;for(;(s|0)>0;--s)e[n]=h=(e[n]^H(h^h>>>30,1664525))+(t[i]|0)+(i|0)|0,n=n+1|0,++i,(n|0)>I&&(e[0]=e[I],n=1),i>=r&&(i=0);for(s=I;(s|0)>0;--s)e[n]=h=(e[n]^H(h^h>>>30,1566083941))-n|0,n=n+1|0,(n|0)>I&&(e[0]=e[I],n=1);e[0]=2147483648}const ne=function(e,t,n){return Math.min(Math.max(e,n),t)};function ie(e){return e==null?new Et(U.autoSeed()):new Et(U.seed(e))}function re(e,t,n){return(e-t)/(n-t)}function B(e,t,n){return e*(1-n)+t*n}class S{constructor(t,n,i,r){c(this,"_a",1);c(this,"_r",0);c(this,"_g",0);c(this,"_b",0);c(this,"_color_array",[0,0,0]);c(this,"_style","rgba(0, 0, 0, 1)");t!=null&&(this._r=t),n!=null&&(this._g=n),i!=null&&(this._b=i),r!=null&&(this._a=r),this.set_value(this._r,this._g,this._b,this._a)}get a(){return this._a}get r(){return this._r}get g(){return this._g}get b(){return this._b}set a(t){this._a=t,this.recreate_style()}set r(t){this._r=t,this.recreate_style()}set g(t){this._g=t,this.recreate_style()}set b(t){this._b=t,this.recreate_style()}get color_array(){return this._color_array[0]=this._r/255,this._color_array[1]=this._g/255,this._color_array[2]=this._b/255,this._color_array}get style(){return this._style}set_value(t,n,i,r){this._r=t,this._g=n,this._b=i,this._a=r,this.recreate_style()}copy_value(t){this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this.recreate_style()}recreate_style(){this._style=`rgba(${this._r}, ${this._g}, ${this._b}, ${this._a})`}static lerp(t,n,i,r){let s=B(t.r,n.r,i),h=B(t.g,n.g,i),o=B(t.b,n.b,i),a=B(t.a,n.a,i);return r!=null?(r.set_value(s,h,o,a),r):new S(s,h,o,a)}}const x=Object.freeze({leave_01:"./assets/textures/leaf_1.png",leave_02:"./assets/textures/leaf_2.png",leave_03:"./assets/textures/leaf_3.png",leave_04:"./assets/textures/leaf_4.png",leave_05:"./assets/textures/leaf_5.png",leave_06:"./assets/textures/leaf_6.png",leave_07:"./assets/textures/leaf_7.png",leave_08:"./assets/textures/leaf_8.png",leave_09:"./assets/textures/leaf_9.png"});x.leave_01,x.leave_02,x.leave_03,x.leave_04,x.leave_05,x.leave_06,x.leave_07,x.leave_08,x.leave_09;const J=Object.freeze({Branch_Length:20,Leaf_ThinBranch_Rate:.5,Leaf_Endpoint_Rate:.8,Leaf_Interact_Color:new S(20,20,255,1)}),wt=Object.freeze({World_Config:"world_config",World_Is_Create:"world_is_create",WorldUpdate:"world_update",ModeInteraction:"mode_interaction"});var Q=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function g(){var e=new Q(2);return Q!=Float32Array&&(e[0]=0,e[1]=0),e}function L(e,t){var n=new Q(2);return n[0]=e,n[1]=t,n}function q(e,t){return e[0]=t[0],e[1]=t[1],e}function tt(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function R(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function et(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e}function Tt(e,t){var n=t[0]-e[0],i=t[1]-e[1];return Math.hypot(n,i)}function D(e,t){var n=t[0],i=t[1],r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e}function se(e,t,n,i){var r=t[0],s=t[1];return e[0]=r+i*(n[0]-r),e[1]=s+i*(n[1]-s),e}function he(e,t,n,i){var r=t[0]-n[0],s=t[1]-n[1],h=Math.sin(i),o=Math.cos(i);return e[0]=r*o-s*h+n[0],e[1]=r*h+s*o+n[1],e}(function(){var e=g();return function(t,n,i,r,s,h){var o,a;for(n||(n=2),i||(i=0),r?a=Math.min(r*n+i,t.length):a=t.length,o=i;o<a;o+=n)e[0]=t[o],e[1]=t[o+1],s(e,e,h),t[o]=e[0],t[o+1]=e[1];return t}})();class oe{constructor(t,n,i,r){c(this,"x");c(this,"y");c(this,"m_width");c(this,"m_height");c(this,"m_center",g());this.x=t,this.y=n,this.m_width=i,this.m_height=r}get width(){return this.m_width}get height(){return this.m_height}get width_half(){return this.m_width*0,5}get height_half(){return this.m_height*.5}get center(){return this.m_center[0]=this.x+this.width_half,this.m_center[1]=this.y+this.height_half,this.m_center}get xMin(){return this.x}get xMax(){return this.x+this.m_width}get yMin(){return this.y}get yMax(){return this.y+this.m_height}}const p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));function ae(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}let nt;const ce=new Uint8Array(16);function _e(){if(!nt){if(typeof crypto=="undefined"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");nt=crypto.getRandomValues.bind(crypto)}return nt(ce)}var xt={randomUUID:typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function At(e,t,n){if(xt.randomUUID&&!t&&!e)return xt.randomUUID();e=e||{};const i=e.random||(e.rng||_e)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){n=n||0;for(let r=0;r<16;++r)t[n+r]=i[r];return t}return ae(i)}const mt=.6;var O=(e=>(e[e.Endpoint_Branch=0]="Endpoint_Branch",e[e.Thin_Branch=1]="Thin_Branch",e[e.Thick_Branch=2]="Thick_Branch",e))(O||{});class C{constructor(t,n){c(this,"id");c(this,"position");c(this,"direction");c(this,"static_position",g());c(this,"static_direction");c(this,"children",[]);c(this,"parent");c(this,"branch_leaf");c(this,"count",0);c(this,"candidate_count",0);c(this,"max_candidate",15);c(this,"child_count",1);c(this,"branch_type",{value:1,type:2});c(this,"style");c(this,"original_style");c(this,"kinematic_flag",0);c(this,"branch_vertices");c(this,"branch_direction_side");c(this,"branch_width");c(this,"is_valid_endpoint",!1);t==null&&n==null||(this.id=At(),this.position=t,q(this.static_position,t),this.branch_direction_side=g(),this.branch_width=g(),this.original_style=new S(220,50,50,.5),this.style=Object.assign(new S,this.original_style),this.branch_vertices=Array.of(g(),g()),this.direction=g(),this.static_direction=g(),this.branch_leaf=[],n!=null&&(this.parent=n.id,R(this.direction,this.position,n.position),D(this.direction,this.direction),this.set_direction(this.direction,!0)))}get is_vertices_set(){return this.branch_vertices[0][0]!=0&&this.branch_vertices[0][1]!=0&&this.branch_vertices[1][0]!=0&&this.branch_vertices[1][1]!=0}get is_root(){return this.parent==null}get thickness(){return this.child_count*mt}get_thickness(){let t=this.child_count*mt;return t=ne(t,t,5),t}reset(){this.direction=q(this.direction,this.static_direction),this.count=0}set_direction(t,n=!1){this.direction=t,n&&q(this.static_direction,this.direction)}next(){let t=et(g(),this.direction,J.Branch_Length),n=tt(g(),this.position,t),i=new C(n,this);return this.children.push(i.id),i}set_branch_type(t){this.branch_type.type=2;const n=.5;this.set_branch_helper(t,15,n,1),this.set_branch_helper(t,3,n,0),this.rebuild_vertices(t)}rebuild_vertices(t){he(this.branch_direction_side,this.direction,L(0,0),Math.PI*.5),et(this.branch_width,this.branch_direction_side,t),this.branch_vertices[0]=tt(this.branch_vertices[0],this.position,this.branch_width),this.branch_vertices[1]=R(this.branch_vertices[1],this.position,this.branch_width)}set_branch_helper(t,n,i,r){if(t<n){let s=n-i;this.branch_type.type=r,this.branch_type.value=1,t>s&&(this.branch_type.value=re(t,s,n));return}}static convert(t){let n=new C;return Object.assign(n,t),n.style=Object.assign(new S,t.style),n.original_style=Object.assign(new S,t.original_style),n}}const It=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],it=1,k=8;class F{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,i]=new Uint8Array(t,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");const r=i>>4;if(r!==it)throw new Error(`Got v${r} data when expected v${it}.`);const s=It[i&15];if(!s)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(t,2,1),[o]=new Uint32Array(t,4,1);return new F(o,h,s,t)}constructor(t,n=64,i=Float64Array,r){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=i,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const s=It.indexOf(this.ArrayType),h=t*2*this.ArrayType.BYTES_PER_ELEMENT,o=t*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-o%8)%8;if(s<0)throw new Error(`Unexpected typed array class: ${i}.`);r&&r instanceof ArrayBuffer?(this.data=r,this.ids=new this.IndexArrayType(this.data,k,t),this.coords=new this.ArrayType(this.data,k+o+a,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(k+h+o+a),this.ids=new this.IndexArrayType(this.data,k,t),this.coords=new this.ArrayType(this.data,k+o+a,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(it<<4)+s]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=t)}add(t,n){const i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=t,this.coords[this._pos++]=n,i}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return rt(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,n,i,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:h,nodeSize:o}=this,a=[0,s.length-1,0],_=[];for(;a.length;){const f=a.pop()||0,l=a.pop()||0,u=a.pop()||0;if(l-u<=o){for(let E=u;E<=l;E++){const vt=h[2*E],Nt=h[2*E+1];vt>=t&&vt<=i&&Nt>=n&&Nt<=r&&_.push(s[E])}continue}const d=u+l>>1,w=h[2*d],T=h[2*d+1];w>=t&&w<=i&&T>=n&&T<=r&&_.push(s[d]),(f===0?t<=w:n<=T)&&(a.push(u),a.push(d-1),a.push(1-f)),(f===0?i>=w:r>=T)&&(a.push(d+1),a.push(l),a.push(1-f))}return _}within(t,n,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:s,nodeSize:h}=this,o=[0,r.length-1,0],a=[],_=i*i;for(;o.length;){const f=o.pop()||0,l=o.pop()||0,u=o.pop()||0;if(l-u<=h){for(let E=u;E<=l;E++)St(s[2*E],s[2*E+1],t,n)<=_&&a.push(r[E]);continue}const d=u+l>>1,w=s[2*d],T=s[2*d+1];St(w,T,t,n)<=_&&a.push(r[d]),(f===0?t-i<=w:n-i<=T)&&(o.push(u),o.push(d-1),o.push(1-f)),(f===0?t+i>=w:n+i>=T)&&(o.push(d+1),o.push(l),o.push(1-f))}return a}}function rt(e,t,n,i,r,s){if(r-i<=n)return;const h=i+r>>1;bt(e,t,h,i,r,s),rt(e,t,n,i,h-1,1-s),rt(e,t,n,h+1,r,1-s)}function bt(e,t,n,i,r,s){for(;r>i;){if(r-i>600){const _=r-i+1,f=n-i+1,l=Math.log(_),u=.5*Math.exp(2*l/3),d=.5*Math.sqrt(l*u*(_-u)/_)*(f-_/2<0?-1:1),w=Math.max(i,Math.floor(n-f*u/_+d)),T=Math.min(r,Math.floor(n+(_-f)*u/_+d));bt(e,t,n,w,T,s)}const h=t[2*n+s];let o=i,a=r;for(Z(e,t,i,n),t[2*r+s]>h&&Z(e,t,i,r);o<a;){for(Z(e,t,o,a),o++,a--;t[2*o+s]<h;)o++;for(;t[2*a+s]>h;)a--}t[2*i+s]===h?Z(e,t,i,a):(a++,Z(e,t,a,r)),a<=n&&(i=a+1),n<=a&&(r=a-1)}}function Z(e,t,n,i){st(e,n,i),st(t,2*n,2*i),st(t,2*n+1,2*i+1)}function st(e,t,n){const i=e[t];e[t]=e[n],e[n]=i}function St(e,t,n,i){const r=e-n,s=t-i;return r*r+s*s}class le{constructor(t,n,i,r){c(this,"m_branch");c(this,"lerp_t");c(this,"relative_angle");c(this,"scale");c(this,"id");this.id=At(),this.m_branch=t,this.lerp_t=n,this.relative_angle=i,this.scale=r}}class ue{constructor(t,n,i){c(this,"m_rand_engine");c(this,"m_leaves",[]);c(this,"m_branches",[]);c(this,"m_branch_dict");c(this,"m_kd_candidates",null);c(this,"m_kd_branches",null);c(this,"m_kd_endpoints",{});c(this,"m_min_distance");c(this,"m_max_distance");this.m_min_distance=t,this.m_max_distance=n,this.m_rand_engine=i,this.m_branch_dict=new Map}get Leaves(){return this.m_leaves}get Branches(){return this.m_branches}get BranchDict(){return this.m_branch_dict}get BranchKD(){return this.m_kd_branches}spawn_attractor(t,n){this.m_kd_candidates=new F(n),this.m_leaves=[];for(let i=0;i<n;i++){let r=this.m_rand_engine.integer(t.xMin,t.xMax),s=this.m_rand_engine.integer(t.yMin,t.yMax),h=L(r,s);this.m_leaves.push({position:h,reached:!1}),this.m_kd_candidates.add(h[0],h[1])}this.m_kd_candidates.finish()}spawn_free_branch(t,n){this.m_branches=[];let i=new C(L(t,n),null);i.direction=L(0,-1),this.m_branches.push(i),this.m_branch_dict.set(i.id,i);let r=i;this.m_leaves.length;let s=5e4;for(;this.m_branches.length<s&&r!=null;){let h=!1,o=this.m_kd_candidates.within(r.position[0],r.position[1],this.m_max_distance),a=o.length;for(let _=0;_<a;_++){let f=this.m_leaves[o[_]];Tt(r.position,f.position)<this.m_max_distance&&(h||(h=!0))}if(!h){let _=r.next();r=_,this.m_branches.push(_),this.m_branch_dict.set(_.id,_);continue}r=null}this.m_kd_branches=this.rebuild_kd_branches(this.m_branches)}grow_branch(){let t=this.m_leaves.length,n=this.m_branches.length;for(let s=0;s<t;s++){let h=this.m_leaves[s],o=null,a=this.m_max_distance,_=this.m_kd_branches.within(h.position[0],h.position[1],this.m_max_distance),f=_.length;for(let l=f-1;l>=0;l--){let u=this.m_branches[_[l]],d=Tt(u.position,h.position);if(d<this.m_min_distance){h.reached=!0,o=null;break}else d<a&&u.candidate_count<u.max_candidate&&(o=u,a=d)}if(o!=null){let l=R(g(),h.position,o.position);D(l,l),o.direction=tt(o.direction,o.direction,l),o.count++,o.candidate_count++}}let i=0;for(let s=t-1;s>=0;s--)this.m_leaves[s].reached&&this.m_leaves.splice(s,1);for(let s=n-1;s>=0;s--){var r=this.m_branches[s];if(r.count>0){let h=r.direction;i++,et(h,h,1/(r.count+1)),r.set_direction(h);let o=r.next();this.m_kd_endpoints[o.id]=o,r.id in this.m_kd_endpoints&&delete this.m_kd_endpoints[r.id],this.m_branches.push(o),this.m_branch_dict.set(o.id,o),r.reset()}}return this.m_kd_candidates=this.rebuild_kd_leaves(this.m_leaves),this.m_kd_branches=this.rebuild_kd_branches(this.m_branches),i}calculate_branch_width(){let t=Object.keys(this.m_kd_endpoints),n=t.length;for(let i=0;i<n;i++){let r=this.m_kd_endpoints[t[i]];for(;r!=null;){r.set_branch_type(r.thickness);let s=this.m_branch_dict.get(r.parent);if(s==null)break;if(s.child_count<=r.child_count)s.child_count=r.child_count+1;else break;r=s}}}calculate_leaf(t){if(t.branch_leaf.length>0||t.branch_type.type==O.Thick_Branch)return;let n=this.m_rand_engine.realZeroToOneInclusive();if(t.branch_type.type==O.Thin_Branch&&n>J.Leaf_ThinBranch_Rate||t.branch_type.type==O.Endpoint_Branch&&n>J.Leaf_Endpoint_Rate)return;let i=this.m_branch_dict.get(t.parent),r=this.m_rand_engine.integer(1,3);for(let s=0;s<r;s++){let h=this.m_rand_engine.realZeroToOneExclusive(),o=se(g(),t.position,i.position,h);o=R(o,o,t.position);let a=.25,_=this.m_rand_engine.real(-1,1)*Math.PI*a,f=this.m_rand_engine.real(-1,1)*Math.PI*a,l=L(_,f);D(l,l);let u=Math.atan2(l[1],l[0]),d=new le(t,h,u,.5);t.branch_leaf.push(d)}}rebuild_kd_branches(t){let n=t.length,i=new F(n);for(let r=0;r<n;r++)i.add(t[r].position[0],t[r].position[1]);return i.finish(),i}rebuild_kd_leaves(t){let n=t.length,i=new F(n);for(let r=0;r<n;r++)i.add(t[r].position[0],t[r].position[1]);return i.finish(),i}}console.log("Hello I am SC Worker");class de{constructor(){c(this,"m_rand_engine");c(this,"m_width");c(this,"m_height");c(this,"m_space_colonization")}execute_sc_colonization_creation(t,n,i){this.m_width=t,this.m_height=n,this.m_rand_engine=ie(i),this.m_space_colonization=new ue(20,100,this.m_rand_engine);let r=n*this.m_rand_engine.real(.4,.8),s=this.m_rand_engine.real(.1,.2),h=this.m_rand_engine.real(.6,.8),o=this.m_rand_engine.integer(250,350),a=new oe(t*s,0,t*h,r);return this.m_space_colonization.spawn_attractor(a,o),this.m_space_colonization.spawn_free_branch(t*.5,n),this.execute_grow_branch_recursion(this.m_space_colonization),this.on_prepare_stage_completed(this.m_space_colonization),this.m_space_colonization}execute_grow_branch_recursion(t){let n=t.grow_branch();if(t.calculate_branch_width(),n==0){t.Branches.forEach(i=>{let r=t.BranchDict.get(i.parent);t.calculate_leaf(i),r!=null&&(R(i.direction,i.position,r.position),D(i.direction,i.direction)),i.rebuild_vertices(i.thickness)});return}this.execute_grow_branch_recursion(t)}on_prepare_stage_completed(t){let n=t.Branches.length;const i=10;for(let r=0;r<n;r++){let s=t.Branches[r],h=t.BranchDict.get(s.parent);if(s.child_count==1){let o=0,a=!1,_=s;for(;!a;){if(o++,o>i){a=!0;continue}if(_.parent==null){a=!0;continue}if(h!=null&&h.child_count-_.child_count>1){a=!0;continue}_=h}o>=i&&(s.is_valid_endpoint=!0)}}}}const fe=new de;self.onmessage=e=>{const t=e.data;switch(console.log("message from main",t),t.event){case wt.World_Config:let n=fe.execute_sc_colonization_creation(t.data.width,t.data.height,t.data.seed);postMessage({event:wt.World_Is_Create,data:{branch_kd:n.BranchKD.data,branches:n.Branches}});break}}})();
