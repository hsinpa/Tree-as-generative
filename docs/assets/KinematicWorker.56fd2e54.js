var H=Object.defineProperty;var N=(d,h,u)=>h in d?H(d,h,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[h]=u;var c=(d,h,u)=>(N(d,typeof h!="symbol"?h+"":h,u),u);(function(){"use strict";var d=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,t=arguments.length;t--;)i+=arguments[t]*arguments[t];return Math.sqrt(i)});function h(){var i=new d(2);return d!=Float32Array&&(i[0]=0,i[1]=0),i}function u(i,t){var e=new d(2);return e[0]=i,e[1]=t,e}function m(i,t){return i[0]=t[0],i[1]=t[1],i}function y(i,t,e){return i[0]=t[0]+e[0],i[1]=t[1]+e[1],i}function M(i,t,e){return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i}function b(i,t,e){return i[0]=t[0]*e,i[1]=t[1]*e,i}function O(i,t){var e=t[0]-i[0],r=t[1]-i[1];return Math.hypot(e,r)}function k(i,t){var e=t[0],r=t[1],n=e*e+r*r;return n>0&&(n=1/Math.sqrt(n)),i[0]=t[0]*n,i[1]=t[1]*n,i}function W(i,t,e,r){var n=t[0],s=t[1];return i[0]=n+r*(e[0]-n),i[1]=s+r*(e[1]-s),i}function U(i,t,e,r){var n=t[0]-e[0],s=t[1]-e[1],a=Math.sin(r),_=Math.cos(r);return i[0]=n*_-s*a+e[0],i[1]=n*a+s*_+e[1],i}function R(i,t){var e=i[0],r=i[1],n=t[0],s=t[1],a=Math.sqrt(e*e+r*r)*Math.sqrt(n*n+s*s),_=a&&(e*n+r*s)/a;return Math.acos(Math.min(Math.max(_,-1),1))}var f=O;(function(){var i=h();return function(t,e,r,n,s,a){var _,l;for(e||(e=2),r||(r=0),n?l=Math.min(n*e+r,t.length):l=t.length,_=r;_<l;_+=e)i[0]=t[_],i[1]=t[_+1],s(i,i,a),t[_]=i[0],t[_+1]=i[1];return t}})();const o=[];for(let i=0;i<256;++i)o.push((i+256).toString(16).slice(1));function j(i,t=0){return(o[i[t+0]]+o[i[t+1]]+o[i[t+2]]+o[i[t+3]]+"-"+o[i[t+4]]+o[i[t+5]]+"-"+o[i[t+6]]+o[i[t+7]]+"-"+o[i[t+8]]+o[i[t+9]]+"-"+o[i[t+10]]+o[i[t+11]]+o[i[t+12]]+o[i[t+13]]+o[i[t+14]]+o[i[t+15]]).toLowerCase()}let K;const L=new Uint8Array(16);function D(){if(!K){if(typeof crypto=="undefined"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");K=crypto.getRandomValues.bind(crypto)}return K(L)}var z={randomUUID:typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function V(i,t,e){if(z.randomUUID&&!t&&!i)return z.randomUUID();i=i||{};const r=i.random||(i.rng||D)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){e=e||0;for(let n=0;n<16;++n)t[e+n]=r[n];return t}return j(r)}const A=function(i,t,e){return Math.min(Math.max(i,e),t)};function q(i,t,e){return(i-t)/(e-t)}function g(i,t,e){return i*(1-e)+t*e}class v{constructor(t,e,r,n){c(this,"_a",1);c(this,"_r",0);c(this,"_g",0);c(this,"_b",0);c(this,"_color_array",[0,0,0]);c(this,"_style","rgba(0, 0, 0, 1)");t!=null&&(this._r=t),e!=null&&(this._g=e),r!=null&&(this._b=r),n!=null&&(this._a=n),this.set_value(this._r,this._g,this._b,this._a)}get a(){return this._a}get r(){return this._r}get g(){return this._g}get b(){return this._b}set a(t){this._a=t,this.recreate_style()}set r(t){this._r=t,this.recreate_style()}set g(t){this._g=t,this.recreate_style()}set b(t){this._b=t,this.recreate_style()}get color_array(){return this._color_array[0]=this._r/255,this._color_array[1]=this._g/255,this._color_array[2]=this._b/255,this._color_array}get style(){return this._style}set_value(t,e,r,n){this._r=t,this._g=e,this._b=r,this._a=n,this.recreate_style()}copy_value(t){this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this.recreate_style()}recreate_style(){this._style=`rgba(${this._r}, ${this._g}, ${this._b}, ${this._a})`}static lerp(t,e,r,n){let s=g(t.r,e.r,r),a=g(t.g,e.g,r),_=g(t.b,e.b,r),l=g(t.a,e.a,r);return n!=null?(n.set_value(s,a,_,l),n):new v(s,a,_,l)}}const p=Object.freeze({leave_01:"./assets/textures/leaf_1.png",leave_02:"./assets/textures/leaf_2.png",leave_03:"./assets/textures/leaf_3.png",leave_04:"./assets/textures/leaf_4.png",leave_05:"./assets/textures/leaf_5.png",leave_06:"./assets/textures/leaf_6.png",leave_07:"./assets/textures/leaf_7.png",leave_08:"./assets/textures/leaf_8.png",leave_09:"./assets/textures/leaf_9.png"});p.leave_01,p.leave_02,p.leave_03,p.leave_04,p.leave_05,p.leave_06,p.leave_07,p.leave_08,p.leave_09;const F=Object.freeze({Branch_Length:20,Leaf_ThinBranch_Rate:.5,Leaf_Endpoint_Rate:.8,Leaf_Interact_Color:new v(20,20,255,1)}),w=Object.freeze({World_Config:"world_config",World_Is_Create:"world_is_create",WorldUpdate:"world_update",ModeInteraction:"mode_interaction"}),C=.6;class I{constructor(t,e){c(this,"id");c(this,"position");c(this,"direction");c(this,"static_position",h());c(this,"static_direction");c(this,"children",[]);c(this,"parent");c(this,"branch_leaf");c(this,"count",0);c(this,"candidate_count",0);c(this,"max_candidate",15);c(this,"child_count",1);c(this,"branch_type",{value:1,type:2});c(this,"style");c(this,"original_style");c(this,"kinematic_flag",0);c(this,"branch_vertices");c(this,"branch_direction_side");c(this,"branch_width");c(this,"is_valid_endpoint",!1);t==null&&e==null||(this.id=V(),this.position=t,m(this.static_position,t),this.branch_direction_side=h(),this.branch_width=h(),this.original_style=new v(220,50,50,.5),this.style=Object.assign(new v,this.original_style),this.branch_vertices=Array.of(h(),h()),this.direction=h(),this.static_direction=h(),this.branch_leaf=[],e!=null&&(this.parent=e.id,M(this.direction,this.position,e.position),k(this.direction,this.direction),this.set_direction(this.direction,!0)))}get is_vertices_set(){return this.branch_vertices[0][0]!=0&&this.branch_vertices[0][1]!=0&&this.branch_vertices[1][0]!=0&&this.branch_vertices[1][1]!=0}get is_root(){return this.parent==null}get thickness(){return this.child_count*C}get_thickness(){let t=this.child_count*C;return t=A(t,t,5),t}reset(){this.direction=m(this.direction,this.static_direction),this.count=0}set_direction(t,e=!1){this.direction=t,e&&m(this.static_direction,this.direction)}next(){let t=b(h(),this.direction,F.Branch_Length),e=y(h(),this.position,t),r=new I(e,this);return this.children.push(r.id),r}set_branch_type(t){this.branch_type.type=2;const e=.5;this.set_branch_helper(t,15,e,1),this.set_branch_helper(t,3,e,0),this.rebuild_vertices(t)}rebuild_vertices(t){U(this.branch_direction_side,this.direction,u(0,0),Math.PI*.5),b(this.branch_width,this.branch_direction_side,t),this.branch_vertices[0]=y(this.branch_vertices[0],this.position,this.branch_width),this.branch_vertices[1]=M(this.branch_vertices[1],this.position,this.branch_width)}set_branch_helper(t,e,r,n){if(t<e){let s=e-r;this.branch_type.type=n,this.branch_type.value=1,t>s&&(this.branch_type.value=q(t,s,e));return}}static convert(t){let e=new I;return Object.assign(e,t),e.style=Object.assign(new v,t.style),e.original_style=Object.assign(new v,t.original_style),e}}class T{constructor(){c(this,"m_open",[]);c(this,"m_cache_direction",h());c(this,"m_zero_vector",h());c(this,"m_rotate_vector1",h());c(this,"m_rotate_vector2",h())}Execute(t,e,r){if(this.m_open.splice(0,this.m_open.length),e.children!=null)for(this.m_open=Object.assign(this.m_open,e.children.map(n=>t.get(n)));this.m_open.length>0;){let n=this.m_open[0],s=t.get(n.parent);if(this.m_open.splice(0,1),n.children!=null&&n.children.forEach(S=>this.m_open.push(t.get(S))),r.has(n.id)||s==null)continue;let a=f(n.static_position,s.static_position),_=R(s.static_direction,s.direction);_<.001&&_>-.001&&(_=0);let l=U(this.m_rotate_vector1,s.static_direction,this.m_zero_vector,-_),E=U(this.m_rotate_vector2,s.static_direction,this.m_zero_vector,_),P=f(E,s.direction)<f(l,s.direction)?1:-1;this.m_cache_direction=U(this.m_cache_direction,n.static_direction,this.m_zero_vector,_*P),m(n.direction,this.m_cache_direction),b(this.m_cache_direction,this.m_cache_direction,a),y(n.position,s.position,this.m_cache_direction),n.rebuild_vertices(n.thickness),t.set(n.id,n)}}}class ${constructor(){c(this,"_open_list",[]);c(this,"_cache_direction",h());c(this,"_cache_position",h());c(this,"_cache_head",h());c(this,"ik_set",new Set)}Execute(t,e,r){this.ik_set.clear();let n=-.001,s=1,a=e,_=m(this._cache_head,r),l=t.get(a.parent);for(;a!=null&&!l.is_root;){l=t.get(a.parent),this.ik_set.add(a.id),this._open_list.push(a),s+=n*a.thickness,s=A(s,1,0);let E=f(l.position,a.position);if(M(this._cache_direction,_,l.position),k(this._cache_direction,this._cache_direction),W(this._cache_direction,a.static_direction,this._cache_direction,s),k(this._cache_direction,this._cache_direction),m(a.direction,this._cache_direction),b(this._cache_direction,this._cache_direction,-1),b(this._cache_direction,this._cache_direction,E),W(_,a.static_position,_,s),y(this._cache_position,_,this._cache_direction),a.position[0]=_[0],a.position[1]=_[1],t.set(a.id,a),_=m(_,this._cache_position),a.parent==null)return a;a=t.get(a.parent)}return this.backward_propagation(t,this._open_list),a}backward_propagation(t,e){let r=e.length;for(let n=r-1;n>=0;n--){let s=e[n],a=t.get(s.parent);if(a==null)continue;M(this._cache_direction,s.position,a.position),k(this._cache_direction,this._cache_direction);let _=f(a.static_position,s.static_position);b(this._cache_position,this._cache_direction,_),y(this._cache_position,this._cache_position,a.position),s.position[0]=this._cache_position[0],s.position[1]=this._cache_position[1],s.rebuild_vertices(s.thickness),t.set(s.id,s)}}}console.log("Hello I am Kinematic Worker");class B{constructor(){c(this,"m_kinematics");c(this,"m_branch_dict",new Map);c(this,"m_forwardKinematic");c(this,"m_invereseKinematic")}get branch_dict(){return this.m_branch_dict}set_branches(t){let e=t.length;this.m_branch_dict.clear();for(let r=0;r<e;r++){let n=I.convert(t[r]);this.m_branch_dict.set(n.id,n)}this.m_forwardKinematic=new T,this.m_invereseKinematic=new $}process(t,e){let r=this.m_branch_dict.get(t);if(this.m_forwardKinematic==null||this.m_invereseKinematic==null||r==null)return;let n=this.m_invereseKinematic.Execute(this.m_branch_dict,r,e);this.m_forwardKinematic.Execute(this.m_branch_dict,n,this.m_invereseKinematic.ik_set)}resume(){this.m_branch_dict.forEach((t,e)=>{if(t.is_root)return;let r=.06;t.position[0]=g(t.position[0],t.static_position[0],r),t.position[1]=g(t.position[1],t.static_position[1],r),t.direction[0]=g(t.direction[0],t.static_direction[0],r),t.direction[1]=g(t.direction[1],t.static_direction[1],r),t.rebuild_vertices(t.thickness)})}}const x=new B;self.onmessage=i=>{const t=i.data;switch(t.event){case w.World_Is_Create:console.log("Kinematics: message from main",t),x.set_branches(t.data.branches);break;case w.ModeInteraction:x.process(t.data.branch_id,u(t.data.x,t.data.y)),postMessage({event:w.WorldUpdate,data:{branch_dict:x.branch_dict}});break;case w.WorldUpdate:x.resume(),postMessage({event:w.WorldUpdate,data:{branch_dict:x.branch_dict}});break}}})();
